<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inclutext</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* FONTS */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        @import url("https://fonts.googleapis.com/css?family=Exo:400,700"); 

        /* ESTILOS BASE Y FONDO DE LA APP */
        * { margin: 0px; padding: 0px; }

        body {
            font-family: 'Exo', 'Inter', sans-serif; 
            background-color:whitesmoke; 
            touch-action: manipulation;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Contenedor de la aplicación que flota sobre el fondo */
        .container-app {
            max-width: 900px; 
            margin: 40px auto;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
            padding: 32px;
            min-height: calc(100vh - 80px);
            position: relative; 
            z-index: 10;
        }
        
        /* Estilos de Inputs y Textareas */
        textarea {
            background-color: #fefefe;
            border: 1px solid #e2e8f0; 
            padding: 16px;
            border-radius: 12px;
            transition: all 0.2s;
            line-height: 1.6; 
        }
        textarea:focus {
            outline: none;
            border-color: #0b50d8;
            box-shadow: 0 0 0 3px rgba(11, 80, 216, 0.2); 
        }

        /* Estilos de Botones de Acción */
        .action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            font-weight: 700;
            border-radius: 12px;
            color: white;
            background-color: #0b50d8;
            box-shadow: 0 4px 10px rgba(11, 80, 216, 0.4);
            transition: background-color 0.2s, box-shadow 0.2s;
            min-width: 200px; 
        }
        .action-button:hover {
            background-color: #0c43a8; 
            box-shadow: 0 6px 15px rgba(11, 80, 216, 0.5);
        }
        .action-button:active {
            transform: translateY(1px);
        }
        .action-button:disabled {
            background-color: #93c5fd; 
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Loader de procesamiento (dentro del botón) */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3); 
            border-top: 4px solid white; 
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mensajes de Error/Éxito */
        .message-box {
            padding: 12px;
            border-radius: 8px;
        }
        .error-box {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #f87171;
        }
        .success-box {
            background-color: #d1fae5; 
            color: #065f46;
            border: 1px solid #34d399;
        }

        /* Contenedor de Resultado */
        .result-card {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-height: 200px; 
        }
        
        /* Estilos para el Quiz (Añadidos para la nueva funcionalidad) */
        .quiz-option {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .quiz-option:hover:not(.correct):not(.incorrect) {
            border-color: #93c5fd;
            background-color: #eff6ff;
        }
        .quiz-option.selected {
            border-color: #0b50d8;
            background-color: #bfdbfe;
        }
        .quiz-option.correct {
            border-color: #10b981; /* Green */
            background-color: #d1fae5;
            animation: pulse-green 0.5s ease-out;
        }
        .quiz-option.incorrect {
            border-color: #ef4444; /* Red */
            background-color: #fee2e2;
            text-decoration: line-through;
            animation: pulse-red 0.5s ease-out;
        }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        
        /* Responsive adjustments */
        @media (max-width: 900px) {
            .container-app {
                margin: 10px;
                padding: 16px;
                max-width: 100%;
            }
        }

        /* ------------------------------------------- */
        /* ESTILOS DE VIDEO DE FONDO Y LOADING */
        /* ------------------------------------------- */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: 1; 
            background-color: #4e54c8; 
            object-fit: cover; 
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(78, 84, 200, 0.8); 
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out; 
        }
        /* Estilos Paciencia y animaciones (mantenidos sin cambios) */
        .paciencia {
            width:344px; height: 69px; line-height: 69px; text-align: center; position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); -o-transform: translate(-50%,-50%); -ms-transform: translate(-50%,-50%); -webkit-transform: translate(-50%,-50%); -moz-transform: translate(-50%,-50%); font-family: helvetica, sans-serif; text-transform: uppercase; font-weight: 900; font-size: 25px; color: #fff;
        }
        .paciencia::before, .paciencia::after {
            content: ""; display: block; width: 21px; height: 21px; background:#1CBADD; position: absolute; animation: cargando 1s infinite alternate ease-in-out; -o-animation: cargando 1s infinite alternate ease-in-out; -ms-animation: cargando 1s infinite alternate ease-in-out; -webkit-animation: cargando 1s infinite alternate ease-in-out; -moz-animation: cargando 1s infinite alternate ease-in-out;
        }
        .paciencia::before {top:0;}
        .paciencia::after {bottom:0;}
        @keyframes cargando {
            0%{left:0;height:41px;width:21px;} 50%{height:11px;width:55px;} 100%{left:323px;height:41px;width:21px;}
        }
        @-o-keyframes cargando {
            0% {left:0;height:41px;width:21px;} 50% {height:11px;width:55px;} 100% {left:323px;height:41px;width:21px;}
        }
        @-ms-keyframes cargando {
            0% {left:0;height:41px;width:21px;} 50% {height:11px;width:55px;} 100% {left:323px;height:41px;width:21px;}
        }
        @-webkit-keyframes cargando {
            0% {left:0;height:41px;width:21px;} 50% {height:11px;width:55px;} 100% {left:323px;height:41px;width:21px;}
        }
        @-moz-keyframes cargando {
            0% {left:0;height:41px;width:21px;} 50% {height:11px;width:55px;} 100% {left:323px;height:41px;width:21px;}
        }
        .loading-hidden {
            opacity: 0 !important;
            pointer-events: none;
            visibility: hidden;
        }
    </style>
</head>
<body class="p-0">
    
    <video autoplay loop muted class="video-background">
        <source src="https://www.dropbox.com/scl/fi/6p2mc934arni2g9tedfxt/educ.mp4?rlkey=uv2gs7o1ulj0snysikh9mpdvg&st=1cb9lbvd&dl=1" type="video/mp4">
        Tu navegador no soporta la etiqueta de video.
    </video>
    
    <div class="loading" id="global-loading-screen">
        <div class="paciencia">Cargando... </div>
    </div>
    
    <div class="container-app">
        
        <header class="mb-8 border-b border-gray-100 pb-4">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <svg class="w-8 h-8 mr-3 text-blue-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M10 8c.34-.65 1-1 2-1 1.07 0 2.06.8 2 2 .1 1.49-.6 2.39-2 3-1.4 1.41-2 3.94-2 5h4"/></svg>
                Inclutext
            </h1>
            <p class="text-gray-500 mt-1">Transforma cualquier texto en un recurso accesible: resumen, audio, vocabulario clave y preguntas de estudio.</p>
        </header>

        <div class="space-y-6 mb-10">
            <textarea id="complex-text" class="w-full h-40 resize-none shadow-sm text-gray-700" placeholder="Pega aquí el texto complejo (ej: un párrafo de un libro de texto avanzado, una noticia técnica, etc.). Se requiere al menos 20 palabras."></textarea>
            
            <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4">
                <button onclick="processAccessibility()" id="process-button" class="action-button w-full md:w-auto">
                    <span id="process-loader" class="loader"></span>
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M16 6l-4-4-4 4"/><path d="M12 2v13"/></svg>
                    Simplificar y Generar Recursos
                </button>
                <p id="process-status" class="text-sm font-medium text-gray-500"></p>
            </div>
            
            <div id="global-message" class="message-box mt-4 hidden"></div>
        </div>

        <div id="results-area" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
            
            <div class="space-y-6">
                
                <div id="summary-card" class="result-card">
                    <h4 class="text-xl font-bold text-gray-700 mb-3 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        Resumen Accesible
                    </h4>
                    <p id="simplified-summary" class="text-gray-800 leading-relaxed min-h-[100px]"></p>
                    
                    <div id="tts-controls" class="flex items-center space-x-3 mt-4 pt-4 border-t border-gray-100">
                         <button onclick="generateTTS()" id="tts-button" class="action-button bg-green-600 hover:bg-green-700 px-4 py-2 text-sm disabled:opacity-50 min-w-0 flex-grow">
                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M17.5 17.5l2.29-2.29"/><path d="M17.5 6.5l2.29 2.29"/></svg>
                            Generar Audio
                        </button>
                        <button onclick="playAudio()" id="tts-play-button" class="action-button bg-gray-500 hover:bg-gray-600 px-4 py-2 text-sm disabled:opacity-50 min-w-0 flex-grow">
                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            Reproducir
                        </button>
                        <audio id="tts-audio-player" class="w-full h-8 hidden"></audio>
                    </div>
                </div>

                <div id="vocabulary-card" class="result-card min-h-0">
                    <h4 class="text-xl font-bold text-gray-700 mb-3 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 7h.01"/><path d="M10 7h.01"/><path d="M13 7h.01"/><path d="M16 7h.01"/></svg>
                        Vocabulario Clave
                    </h4>
                    <div id="vocabulary-list" class="space-y-3">
                        </div>
                </div>
            </div>

            <div class="space-y-6">
                <div id="quiz-card" class="result-card min-h-[430px]">
                    <h4 class="text-xl font-bold text-gray-700 mb-4 flex items-center border-b pb-2">
                         <svg class="w-6 h-6 mr-2 text-purple-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 12h8"/><path d="M8 16h8"/></svg>
                        Mini-Quiz de Comprensión
                    </h4>
                    <div id="quiz-container" class="space-y-6">
                        <p class="text-gray-500">El Quiz aparecerá aquí después de simplificar el texto.</p>
                        </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        const BACKEND_URL = "http://127.0.0.1:5001";
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let geminiStructuredResponse = null; 
        let quizAnswers = [];
        let currentAudioUrl = null;

        // --- Funciones de Utilidad ---

        function showMessage(msg, elementId, isError = true) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.textContent = msg;
            el.classList.remove('hidden', 'error-box', 'success-box');
            el.classList.add('message-box');

            if (isError) {
                el.classList.add('error-box');
            } else {
                el.classList.add('success-box');
            }
            if (!msg) el.classList.add('hidden');
        }

        function setAppState(isLoading, statusText = '') {
            const button = document.getElementById('process-button');
            const loader = document.getElementById('process-loader');
            const status = document.getElementById('process-status');

            button.disabled = isLoading;
            loader.style.display = isLoading ? 'inline-block' : 'none';
            status.textContent = statusText;
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;
            view.setUint32(offset, 0x52494646, false); offset += 4;
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            view.setUint32(offset, 0x57415645, false); offset += 4;
            view.setUint32(offset, 0x666d7420, false); offset += 4;
            view.setUint32(offset, 16, true); offset += 4;
            view.setUint16(offset, 1, true); offset += 2;
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, 16, true); offset += 2;
            view.setUint32(offset, 0x64617461, false); offset += 4;
            view.setUint32(offset, dataSize, true); offset += 4;
            
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // ====================================================================
        // FUNCIÓN PRINCIPAL CORREGIDA
        // ====================================================================

        async function processAccessibility() {
            const complexText = document.getElementById('complex-text').value.trim();
            const resultsAreaEl = document.getElementById('results-area');
            const summaryEl = document.getElementById('simplified-summary');
            const vocabListEl = document.getElementById('vocabulary-list');
            const quizContainerEl = document.getElementById('quiz-container');
            const ttsButtonEl = document.getElementById('tts-button');
            const ttsPlayButtonEl = document.getElementById('tts-play-button');

            if (complexText.split(' ').length < 20) {
                showMessage('El texto es muy corto. Por favor, pega un texto de al menos 20 palabras para un análisis significativo.', 'global-message', true);
                return;
            }

            // Limpieza y estado inicial
            geminiStructuredResponse = null;
            quizAnswers = [];
            setAppState(true, 'Iniciando proceso: Simplificación de texto y generación de Quiz...');
            resultsAreaEl.classList.remove('hidden');
            showMessage('', 'global-message', false);
            summaryEl.innerHTML = '<p class="text-gray-500">Cargando...</p>';
            vocabListEl.innerHTML = '<p class="text-gray-500">Cargando...</p>';
            quizContainerEl.innerHTML = '<p class="text-gray-500">Cargando preguntas...</p>';
            
            ttsButtonEl.disabled = true;
            ttsPlayButtonEl.disabled = true;

            try {
                // ✅ LLAMA A TU BACKEND SEGURO
                const response = await fetch(`${BACKEND_URL}/api/process-text`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: complexText })
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }

                // ✅ USA LOS DATOS DEL BACKEND
                geminiStructuredResponse = result.data;

                // Mostrar Resumen, Vocabulario y Quiz
                const summary = geminiStructuredResponse.simplifiedSummary || '';
                if (!summary || summary.length < 10) {
                    throw new Error("El resumen está vacío o es muy corto.");
                }
                
                summaryEl.textContent = summary;
                
                const vocab = geminiStructuredResponse.keyVocabulary || [];
                vocabListEl.innerHTML = vocab.map(item => `
                    <div class="border border-gray-200 p-4 rounded-xl bg-white shadow-sm hover:shadow-md transition">
                        <p class="font-bold text-lg text-blue-700">${item.word}</p>
                        <p class="text-gray-700 mt-1">${item.simpleDefinition}</p>
                    </div>
                `).join('');

                // Generar y mostrar Quiz
                renderQuiz(geminiStructuredResponse.multipleChoiceQuestions || []);
                
                ttsButtonEl.disabled = false;
                setAppState(false, 'Simplificación y Quiz listos. Listo para generar audio.');
                showMessage('Resumen, vocabulario y Mini-Quiz de estudio listos.', 'global-message', false);

            } catch (e) {
                console.error("Error en el proceso principal:", e);
                summaryEl.textContent = 'Error: No se pudo procesar el texto.';
                vocabListEl.textContent = 'Error al cargar vocabulario.';
                quizContainerEl.innerHTML = '<p class="text-red-500">Error al cargar el quiz.</p>';
                showMessage(`Ocurrió un error: ${e.message}`, 'global-message', true);
            } finally {
                setAppState(false, 'Proceso finalizado.');
            }
        }

        // Función para renderizar el Quiz
        function renderQuiz(questions) {
            const quizContainerEl = document.getElementById('quiz-container');
            quizContainerEl.innerHTML = '';
            quizAnswers = questions.map(q => q.correctIndex);
            
            if (questions.length === 0) {
                 quizContainerEl.innerHTML = '<p class="text-gray-500">No se pudieron generar preguntas de quiz basadas en el resumen.</p>';
                 return;
            }

            questions.forEach((q, qIndex) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'mb-6';
                qDiv.innerHTML = `<p class="font-semibold text-gray-800 mb-2">Pregunta ${qIndex + 1}: ${q.question}</p>`;

                q.options.forEach((option, oIndex) => {
                    const optionP = document.createElement('p');
                    optionP.className = 'quiz-option'; 
                    optionP.textContent = `${String.fromCharCode(65 + oIndex)}. ${option}`;
                    optionP.setAttribute('data-q-index', qIndex);
                    optionP.setAttribute('data-o-index', oIndex);
                    optionP.onclick = handleQuizAnswer;
                    qDiv.appendChild(optionP);
                });

                quizContainerEl.appendChild(qDiv);
            });
        }
        
        // Función para manejar la selección de respuesta
        function handleQuizAnswer(event) {
            const selectedOption = event.target;
            const qIndex = parseInt(selectedOption.getAttribute('data-q-index'));
            const oIndex = parseInt(selectedOption.getAttribute('data-o-index'));
            const correctIndex = quizAnswers[qIndex];

            const options = document.querySelectorAll(`[data-q-index="${qIndex}"]`);
            options.forEach(opt => {
                opt.onclick = null;
                opt.classList.remove('selected');
                
                const index = parseInt(opt.getAttribute('data-o-index'));
                
                if (index === oIndex) {
                    opt.classList.add('selected');
                    if (index === correctIndex) {
                        opt.classList.add('correct');
                    } else {
                        opt.classList.add('incorrect');
                    }
                }
                
                if (index === correctIndex && index !== oIndex) {
                    opt.classList.add('correct');
                }
            });
        }

        // ====================================================================
        // FUNCIÓN TTS CORREGIDA
        // ====================================================================
        
        async function generateTTS() {
            const prompt = geminiStructuredResponse?.simplifiedSummary || '';
            const audioPlayerEl = document.getElementById('tts-audio-player');
            const ttsButtonEl = document.getElementById('tts-button');
            const ttsPlayButtonEl = document.getElementById('tts-play-button');
            
            if (!prompt || prompt.length < 10) {
                showMessage('El resumen está vacío. Presiona "Simplificar" primero.', 'global-message', true);
                return;
            }

            ttsButtonEl.disabled = true;
            ttsPlayButtonEl.disabled = true;
            audioPlayerEl.classList.add('hidden');

            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
            }
            
            document.getElementById('process-status').textContent = 'Generando audio...';
            showMessage('Generando audio, por favor espera...', 'global-message', false);

            try {
                // ✅ LLAMA A TU BACKEND PARA TTS
                const response = await fetch(`${BACKEND_URL}/api/generate-audio`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: prompt })
                });

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }

                const audioData = result.audioData;
                const mimeType = result.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    currentAudioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayerEl.src = currentAudioUrl;
                    audioPlayerEl.classList.remove('hidden');
                    ttsPlayButtonEl.disabled = false;
                    document.getElementById('process-status').textContent = 'Audio listo. Presiona Reproducir.';
                    showMessage('Audio generado con éxito. Ya puedes reproducirlo.', 'global-message', false);
                } else {
                    throw new Error("No se recibieron datos de audio válidos.");
                }

            } catch (e) {
                console.error("Error en la generación de TTS:", e);
                showMessage(`Error de Audio: ${e.message}`, 'global-message', true);
            } finally {
                ttsButtonEl.disabled = false; 
            }
        }

        function playAudio() {
            const audioPlayerEl = document.getElementById('tts-audio-player');
            if (audioPlayerEl.src) {
                audioPlayerEl.play();
            } else {
                showMessage('Genera el audio primero.', 'global-message', true);
            }
        }

        // ====================================================================
        // LÓGICA DE PANTALLA DE CARGA
        // ====================================================================
        
        let isContentLoaded = false;
        let isTimerFinished = false;

        function hideLoadingScreen() {
            isContentLoaded = true;
            attemptHideLoadingScreen();
        }

        function startTimer() {
            setTimeout(() => {
                isTimerFinished = true;
                attemptHideLoadingScreen();
            }, 5000);
        }

        function attemptHideLoadingScreen() {
            const loadingScreen = document.getElementById('global-loading-screen');
            if (isContentLoaded && isTimerFinished) {
                 loadingScreen.classList.add('loading-hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', hideLoadingScreen);
        window.addEventListener('load', startTimer);
    </script>
</body>
</html>




